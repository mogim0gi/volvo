###############################################################################
# PACKAGE: EV Charge Controller - XC60 V7.3 (LITE - DIRECT NORDPOOL)
###############################################################################

# --- 1. INPUTS ---
input_select:
  ev_charge_mode:
    name: Charging Mode
    options: ["Auto (Smart)", "Manual Limit", "Force Charge"]
    initial: "Auto (Smart)"
    icon: mdi:car-electric

input_number:
  ev_limit_override_value:
    name: Manual Price Limit
    min: 0
    max: 50
    step: 0.5
    unit_of_measurement: "c/kWh"
    initial: 10
    icon: mdi:currency-eur
  
  # Session Helpers
  ev_session_start_energy:
    name: Session Start Energy Snapshot
    mode: box
    min: 0
    max: 1000000
  ev_session_start_cost:
    name: Session Start Cost Snapshot
    mode: box
    min: 0
    max: 1000000

input_datetime:
  ev_ready_by:
    name: Ready By Time
    has_date: false
    has_time: true
    initial: "07:00:00"
    icon: mdi:clock-check-outline


# --- 2. TEMPLATE SENSORS ---
template:
  - sensor:
      # [THE BRAIN: V8.0 - BULLETPROOF LOGIC]
      - name: "EV Smart Charging Limit"
        unique_id: ev_smart_charging_limit_v8_0_final
        unit_of_measurement: "c/kWh"
        state: "{{ this.attributes.calculated_limit | default(0) | float(0) }}"
        attributes:
          calculated_limit: >
            {% set mode = states('input_select.ev_charge_mode') %}
            {% if mode == 'Force Charge' %} 999.0
            {% elif mode == 'Manual Limit' %} {{ states('input_number.ev_limit_override_value') | float(0) }}
            {% else %}
              {% set soc = states('sensor.volvo_xc60_battery') | float(0) %}
              {% set hrs_need = ((100-soc)/5)*(35/60) if soc >= 95 else (16.8*((95-soc)/100)/3.15 + 35/60) %}
              
              {% set t = now() %}
              {% set r = states('input_datetime.ev_ready_by') | default('07:00:00') %}
              {% set dl = t.replace(hour=r.split(':')[0]|int, minute=r.split(':')[1]|int, second=0) %}
              {% if dl <= t %}{% set dl = dl + timedelta(days=1) %}{% endif %}
              
              {% set is_tomorrow = dl.strftime('%F') > t.strftime('%F') %}
              {% set is_blind = (state_attr('sensor.nordpool_enefit', 'raw_tomorrow')|length == 0 and is_tomorrow) %}
              
              {% set blind_start = dl.replace(hour=0, minute=0, second=0) %}
              {% set night_capacity = (as_timestamp(dl) - as_timestamp(blind_start)) / 3600 %}
              {% set deficit = hrs_need - night_capacity %}

              {% if hrs_need > (as_timestamp(dl)-as_timestamp(t))/3600 %} 999.0
              {% elif is_blind and t.hour >= 22 %} 999.0
              {% elif is_blind and deficit > 0 %}
                 {% set deficit_slots = (deficit * 4) | round(0, 'ceil') | int %}
                 {% set today = state_attr('sensor.nordpool_enefit', 'raw_today') or [] %}
                 {% set c = namespace(l=[]) %}
                 {% for s in today %}{% if as_datetime(s.end) > t %}{% set c.l = c.l + [s.value * 100] %}{% endif %}{% endfor %}
                 {% set sorted_today = c.l | sort %}
                 {% if sorted_today|length >= deficit_slots %}{{ sorted_today[deficit_slots - 1] | round(2) }}{% else %}999.0{% endif %}
              {% elif is_blind %}
                 {% set today = state_attr('sensor.nordpool_enefit', 'raw_today') or [] %}
                 {% set ns = namespace(sum=0, count=0) %}
                 {% for s in today %}{% if as_datetime(s.start).hour < 7 %}{% set ns.sum = ns.sum + s.value %}{% set ns.count = ns.count + 1 %}{% endif %}{% endfor %}
                 {{ ((ns.sum / ns.count) * 100) | round(2) if ns.count > 0 else 4.0 }}
              {% else %}
                {% set slots = (hrs_need * 4) | round(0, 'ceil') | int %}
                {% set all = (state_attr('sensor.nordpool_enefit', 'raw_today') or []) + (state_attr('sensor.nordpool_enefit', 'raw_tomorrow') or []) %}
                {% set c = namespace(l=[]) %}
                {% for s in all %}
                  {% if as_datetime(s.end) > t and as_datetime(s.start) < dl %}
                    {% set c.l = c.l + [s.value * 100] %}
                  {% endif %}
                {% endfor %}
                {% set sorted = c.l | sort %}
                {{ sorted[slots-1] | round(2) if sorted|length >= slots else (sorted[-1] if sorted|length > 0 else 0) }}
              {% endif %}
            {% endif %}

          schedule_text: >
            {% set mode = states('input_select.ev_charge_mode') %}
            {% if mode == 'Force Charge' %} Always Charging
            {% else %}
              {% set t = now() %}
              {% set r = states('input_datetime.ev_ready_by') | default('07:00:00') %}
              {% set dl = t.replace(hour=r.split(':')[0]|int, minute=r.split(':')[1]|int, second=0) %}
              {% if dl <= t %}{% set dl = dl + timedelta(days=1) %}{% endif %}
              {% set is_tomorrow = dl.strftime('%F') > t.strftime('%F') %}
              {% set is_blind = (state_attr('sensor.nordpool_enefit', 'raw_tomorrow')|length == 0 and is_tomorrow) %}
              {% set soc = states('sensor.volvo_xc60_battery') | float(0) %}
              {% set hrs_need = ((100-soc)/5)*(35/60) if soc >= 95 else (16.8*((95-soc)/100)/3.15 + 35/60) %}
              {% set blind_start = dl.replace(hour=0, minute=0, second=0) %}
              {% set night_capacity = (as_timestamp(dl) - as_timestamp(blind_start)) / 3600 %}
              {% set deficit = hrs_need - night_capacity %}
              {% set lim = this.attributes.calculated_limit | default(0) | float %}
              
              {% if is_blind and t.hour >= 22 %}
                 âš ï¸ DATA OFFLINE: Force Charging
              {% elif is_blind and mode == 'Auto (Smart)' and deficit > 0 %}
                 {% set today = state_attr('sensor.nordpool_enefit', 'raw_today') or [] %}
                 {% set c = namespace(l=[]) %}
                 {% for s in today %}
                   {% if as_datetime(s.end) > t and (s.value * 100) <= lim + 0.01 %}
                     {% set c.l = c.l + [s] %}
                   {% endif %}
                 {% endfor %}
                 {% set sel = c.l | sort(attribute='start') %}
                 {% set ns = namespace(res="", s=none, e=none) %}
                 {% for s in sel %}{% set ss = as_datetime(s.start) %}{% set se = as_datetime(s.end) %}{% if ns.s is none %}{% set ns.s = ss %}{% set ns.e = se %}{% elif ss == ns.e %}{% set ns.e = se %}{% else %}{% set ns.res = ns.res + ns.s.strftime('%H:%M') + "-" + ns.e.strftime('%H:%M') + ", " %}{% set ns.s = ss %}{% set ns.e = se %}{% endif %}{% endfor %}{% if ns.s is not none %}{% set ns.res = ns.res + ns.s.strftime('%H:%M') + "-" + ns.e.strftime('%H:%M') %}{% endif %}
                 {{ ns.res }} + 00:00-{{ r[:5] }} (Est)
              {% elif is_blind and mode == 'Auto (Smart)' %}
                 00:00-{{ r[:5] }} (Est @ {{ lim }}c)
              {% else %}
                {% set raw = (state_attr('sensor.nordpool_enefit', 'raw_today') or []) + (state_attr('sensor.nordpool_enefit', 'raw_tomorrow') or []) %}
                {% set c = namespace(l=[]) %}
                {% for s in raw %}
                  {% if as_datetime(s.end) > t and as_datetime(s.start) < dl and (s.value * 100) <= lim+0.01 %}
                    {% set c.l = c.l + [s] %}
                  {% endif %}
                {% endfor %}
                {% set sel = c.l | sort(attribute='start') %}
                {% set ns = namespace(res="", s=none, e=none) %}
                {% for s in sel %}{% set ss = as_datetime(s.start) %}{% set se = as_datetime(s.end) %}{% if ns.s is none %}{% set ns.s = ss %}{% set ns.e = se %}{% elif ss == ns.e %}{% set ns.e = se %}{% else %}{% set ns.res = ns.res + ns.s.strftime('%H:%M') + "-" + ns.e.strftime('%H:%M') + ", " %}{% set ns.s = ss %}{% set ns.e = se %}{% endif %}{% endfor %}{% if ns.s is not none %}{% set ns.res = ns.res + ns.s.strftime('%H:%M') + "-" + ns.e.strftime('%H:%M') %}{% endif %}
                {{ ns.res if ns.res != "" else "None" }}
              {% endif %}
            {% endif %}

          ui_status: >
             {% set mode = states('input_select.ev_charge_mode') %}
             {% if mode == 'Force Charge' %}Charging
             {% elif states('sensor.volvo_xc60_battery')|float >= 100 %}Idle
             {% elif is_state('switch.breaker_switch','on') %}Charging
             {% elif 'Est' in (this.attributes.schedule_text | default('')) %}Predicting
             {% elif 'Gap' in (this.attributes.schedule_text | default('')) %}Gap Filling
             {% elif 'pending' in (this.attributes.schedule_text | default('pending')) %}Waiting
             {% else %}Paused{% endif %}

          ui_reason: >
             {% set mode = states('input_select.ev_charge_mode') %}
             {% set soc = states('sensor.volvo_xc60_battery') | float(0) %}
             {% set sched = this.attributes.schedule_text | default('pending') %}
             {% if mode == 'Force Charge' %} âš ï¸ Force Charge Active
             {% elif soc >= 100 %} âœ… Battery is full
             {% elif mode == 'Manual Limit' %} ðŸ”’ Manual Limit ({{ states('input_number.ev_limit_override_value') }}c) Active
             {% elif is_state('switch.breaker_switch','on') %} âš¡ Charging (Price is good)
             {% elif 'DATA OFFLINE' in sched %} ðŸ†˜ API Failure: Safety Charge
             {% elif 'Gap' in sched %} ðŸ“‰ Filling gap with cheapest slots
             {% elif 'Est' in sched %} ðŸ”® Prediction: Tomorrow morning is cheap
             {% elif sched == 'pending' %} â³ Waiting for tomorrow's prices (~14:00)
             {% else %} ðŸ’¤ Waiting for cheaper slots {% endif %}

      # [MISSING SENSOR RESTORED: Total Power in kW]
      - name: "Breaker Total Power kW v4"
        unique_id: breaker_total_power_kw_v4_unified
        unit_of_measurement: "kW"
        device_class: power
        state: >
          {% set p = states('sensor.breaker_phase_a_power')|float(0) + states('sensor.breaker_phase_b_power')|float(0) + states('sensor.breaker_phase_c_power')|float(0) %}
          {{ (p / 1000) | round(3) }}

      - name: "Breaker Cost Rate v4"
        unique_id: breaker_cost_rate_v4_unified
        unit_of_measurement: "EUR/h"
        state: >
          {% set p = states('sensor.breaker_total_power_kw_v4')|float(0) %}
          {% set price_cents = state_attr('sensor.nordpool_enefit', 'current_price') | float(0) * 100 %}
          {{ (p * price_cents / 100) | round(3) }}

# [FIX 4: Average Price Calculation]
      - name: "Breaker Average Price v4"
        unique_id: breaker_average_price_v4_unified
        unit_of_measurement: "c/kWh"
        state: >
          {% set c = states('sensor.breaker_total_cost_v4') | float(0) %}
          {% set e = states('sensor.breaker_total_energy_v4') | float(0) %}
          {{ ((c / e) * 100) | round(2) if e > 0 else 0 }}

# --- 3. INTEGRATION SENSORS ---
sensor:
  - platform: integration
    unique_id: breaker_total_energy_v4_integrated
    source: sensor.breaker_total_power_kw_v4
    name: "Breaker Total Energy v4"
    method: left
    unit_time: h
    round: 3  # [FIX 2: Add this]
  - platform: integration
    unique_id: breaker_total_cost_v4_integrated
    source: sensor.breaker_cost_rate_v4
    name: "Breaker Total Cost v4"
    method: left
    unit_time: h
    round: 3  # [FIX 3: Add this]

# --- 4. UTILITY METERS ---
utility_meter:
  breaker_daily_energy_v4:
    source: sensor.breaker_total_energy_v4
    cycle: daily
  breaker_daily_cost_v4:
    source: sensor.breaker_total_cost_v4
    cycle: daily
  breaker_monthly_energy_v4:
    source: sensor.breaker_total_energy_v4
    cycle: monthly
  breaker_monthly_cost_v4:
    source: sensor.breaker_total_cost_v4
    cycle: monthly

# --- 5. AUTOMATIONS ---
automation:
  # 1. MAIN CHARGE CONTROLLER (Simplified)
  - alias: "EV â€“ Charge Controller (XC60 V7.3)"
    id: ev_charge_controller_xc60_v7_3
    mode: restart
    trigger:
      - platform: time_pattern
        minutes: "/1"
      - platform: state
        entity_id: 
          - sensor.volvo_xc60_battery
          - sensor.ev_smart_charging_limit
          - input_select.ev_charge_mode
          - sensor.nordpool_enefit
    action:
      - variables:
          soc: "{{ states('sensor.volvo_xc60_battery') | float(0) }}"
          limit: "{{ states('sensor.ev_smart_charging_limit') | float(0) }}"
          # FIX: Direct read. We trust the sensor now (with *100 fix for EUR)
          current_price: "{{ state_attr('sensor.nordpool_enefit', 'current_price') | float(0) * 100 }}"
      - choose:
          - conditions: ["{{ soc < 100 }}", "{{ current_price <= limit + 0.01 }}", "{{ limit > 0 }}"]
            sequence: [{ service: switch.turn_on, target: { entity_id: switch.breaker_switch } }]
          - conditions: []
            sequence: [{ service: switch.turn_off, target: { entity_id: switch.breaker_switch } }]

  # 2. NOTIFY ON PLUGGED IN (Same as before)
  - alias: "EV â€“ Notify on Plugged In"
    id: ev_notify_plugged_in
    mode: single
    trigger:
      - platform: state
        entity_id: sensor.volvo_xc60_charging_connection_status
        to: "Connected"
    action:
      - service: homeassistant.update_entity
        target: { entity_id: device_tracker.volvo_xc60_location }
      - wait_template: "{{ is_state('device_tracker.volvo_xc60_location', 'home') }}"
        timeout: "00:15:00"
        continue_on_timeout: true
      - choose:
          - conditions: [{ condition: state, entity_id: device_tracker.volvo_xc60_location, state: "home" }]
            sequence:
              - service: input_number.set_value
                target: { entity_id: input_number.ev_session_start_energy }
                data: { value: "{{ states('sensor.breaker_total_energy_v4') | float(0) }}" }
              - service: input_number.set_value
                target: { entity_id: input_number.ev_session_start_cost }
                data: { value: "{{ states('sensor.breaker_total_cost_v4') | float(0) }}" }
              - service: notify.mobile_app_g
                data:
                  title: "ðŸ  Plugged in at Home"
                  message: "Plan: {{ states('sensor.ev_smart_charging_limit') }}c. \n{{ state_attr('sensor.ev_smart_charging_limit', 'schedule_text') }}"
                  data: { tag: "volvo_charge_alert", actions: [{ action: "FORCE_CHARGE", title: "ðŸš€ Force" }, { action: "SMART_AUTO", title: "ðŸ¤– Auto" }] }
          - conditions: []
            sequence:
              - service: notify.mobile_app_g
                data: { title: "ðŸŒ Charging External", message: "Volvo plugged in away from home." }

  # 3. NOTIFY ACTIONS (Same as before)
  - alias: "EV â€“ Handle Notification Actions"
    id: ev_handle_notification_actions
    mode: parallel
    trigger:
      - platform: event
        event_type: mobile_app_notification_action
    action:
      - choose:
          - conditions: "{{ wait.trigger.event.data.action == 'FORCE_CHARGE' }}"
            sequence:
              - service: input_select.select_option
                target: { entity_id: input_select.ev_charge_mode }
                data: { option: "Force Charge" }
              - service: notify.mobile_app_g
                data: { message: "Force Charge Active", data: { tag: "volvo_charge_alert" } }
          - conditions: "{{ wait.trigger.event.data.action == 'SMART_AUTO' }}"
            sequence:
              - service: input_select.select_option
                target: { entity_id: input_select.ev_charge_mode }
                data: { option: "Auto (Smart)" }
              - service: notify.mobile_app_g
                data: { message: "Auto Smart Active", data: { tag: "volvo_charge_alert" } }

  # 4. NOTIFY FULLY CHARGED (With DND Fix)
  - alias: "EV â€“ Notify Fully Charged"
    id: ev_notify_fully_charged
    mode: single
    trigger:
      - platform: numeric_state
        entity_id: sensor.volvo_xc60_battery
        above: 99
    action:
      - choose:
          - conditions: [{ condition: state, entity_id: device_tracker.volvo_xc60_location, state: "home" }]
            sequence:
              - service: notify.mobile_app_g
                data:
                  title: "âœ… Charging Complete"
                  message: >
                    Full (Home).
                    âš¡ {{ (states('sensor.breaker_total_energy_v4')|float - states('input_number.ev_session_start_energy')|float)|round(2) }} kWh
                    ðŸ’¶ {{ (states('sensor.breaker_total_cost_v4')|float - states('input_number.ev_session_start_cost')|float)|round(2) }}â‚¬
                  data: { push: { sound: { name: default, critical: 1, volume: 1.0 } }, importance: high, priority: high }
          - conditions: []
            sequence:
              - service: notify.mobile_app_g
                data: { title: "âœ… Charging Complete", message: "Volvo is fully charged (External)." }

  # 5. SMART RESET (Same as before)
  - alias: "EV â€“ Smart Reset on Departure"
    id: ev_smart_reset_on_departure
    mode: restart
    trigger:
      - platform: state
        entity_id: sensor.volvo_xc60_charging_connection_status
        from: "Connected"
        for: { minutes: 5 }
    action:
      - service: input_datetime.set_datetime
        target: { entity_id: input_datetime.ev_ready_by }
        data: { time: "07:00:00" }
      - service: input_select.select_option
        target: { entity_id: input_select.ev_charge_mode }
        data: { option: "Auto (Smart)" }

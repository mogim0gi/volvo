###############################################################################
# PACKAGE: EV Charge Controller - XC60 V7.3 (LITE - DIRECT NORDPOOL)
###############################################################################

# --- 1. INPUTS ---
input_select:
  ev_charge_mode:
    name: Charging Mode
    options: ["Auto (Smart)", "Manual Limit", "Force Charge"]
    initial: "Auto (Smart)"
    icon: mdi:car-electric

input_number:
  ev_limit_override_value:
    name: Manual Price Limit
    min: 0
    max: 50
    step: 0.5
    unit_of_measurement: "c/kWh"
    initial: 10
    icon: mdi:currency-eur


input_datetime:
  ev_ready_by:
    name: Ready By Time
    has_date: false
    has_time: true
    initial: "07:00:00"
    icon: mdi:clock-check-outline


# --- 2. TEMPLATE SENSORS ---
template:
  - sensor:
      - name: "EV Smart Charging Limit"
        unique_id: ev_smart_charging_limit_v8_8_stable
        unit_of_measurement: "c/kWh"
        state: "{{ this.attributes.calculated_limit | default(0) | float(0) }}"
        attributes:
          calculated_limit: >
            {# --- 1. SENSOR CHECKS --- #}
            {% set volvo_state = states('sensor.volvo_xc60_battery') %}
            {# MAKE SURE THIS MATCHES YOUR SENSOR NAME #}
            {% set nordpool_sensor = 'sensor.nordpool_enefit' %}
            {% set nordpool_state = states(nordpool_sensor) %}
            {% set nordpool_today = state_attr(nordpool_sensor, 'raw_today') %}
            
            {# --- 2. STABILIZER (The Fix) --- #}
            {# If data vanishes briefly (update glitch), KEEP THE OLD VALUE. Do not drop to 0. #}
            {% if nordpool_state in ['unavailable', 'unknown'] or nordpool_today is none %}
                {{ states('sensor.ev_smart_charging_limit') | float(0) }}

            {# --- 3. SAFETY (Only if Car is offline) --- #}
            {% elif volvo_state in ['unavailable', 'unknown', 'none'] %}
                0.0

            {# --- 4. NORMAL LOGIC --- #}
            {% else %}
              {% set soc = volvo_state | float(0) %}
              {% set mode = states('input_select.ev_charge_mode') %}
              
              {% if soc >= 100 %} 0.0
              {% elif mode == 'Force Charge' %} 999.0
              {% elif mode == 'Manual Limit' %} {{ states('input_number.ev_limit_override_value') | float(0) }}
              {% else %}
                {% set hrs_need = ((100-soc)/5)*(35/60) if soc >= 95 else (16.8*((95-soc)/100)/3.15 + 35/60) %}
                {% set t = now() %}
                {% set r = states('input_datetime.ev_ready_by') | default('07:00:00') %}
                {% set dl = t.replace(hour=r.split(':')[0]|int, minute=r.split(':')[1]|int, second=0) %}
                {% if dl <= t %}{% set dl = dl + timedelta(days=1) %}{% endif %}
                
                {% set raw_tomorrow = state_attr(nordpool_sensor, 'raw_tomorrow') %}
                {% set is_tomorrow = dl.strftime('%F') > t.strftime('%F') %}
                {% set is_blind = (raw_tomorrow|length == 0 and is_tomorrow) %}
                
                {% if is_blind %}
                   0.0
                {% else %}
                  {% set slots = (hrs_need * 4) | round(0, 'ceil') | int %}
                  {% set all = (nordpool_today or []) + (raw_tomorrow or []) %}
                  {% set c = namespace(l=[]) %}
                  {% for s in all %}
                    {% if as_datetime(s.end) > t and as_datetime(s.start) < dl %}
                      {% set c.l = c.l + [s.value * 100] %}
                    {% endif %}
                  {% endfor %}
                  {% set sorted = c.l | sort %}
                  {{ sorted[slots-1] | round(2) if sorted|length >= slots else (sorted[-1] if sorted|length > 0 else 0) }}
                {% endif %}
              {% endif %}
            {% endif %}

          schedule_text: >
            {# --- 1. SETUP & STABILIZER --- #}
            {% set nordpool_sensor = 'sensor.nordpool_enefit' %}
            {% set raw_today = state_attr(nordpool_sensor, 'raw_today') %}
            
            {# STABILIZER: If data vanishes for 1 second during update, SHOW OLD TEXT. #}
            {% if raw_today is none %} 
              {{ this.attributes.schedule_text | default('Wait...') }}
            
            {# --- 2. STATUS CHECKS --- #}
            {% else %}
              {% set soc = states('sensor.volvo_xc60_battery') | float(0) %}
              {% set lim = this.attributes.calculated_limit | default(0) | float %}
              
              {% if soc >= 100 %} âœ… Full
              {% elif lim == 0.0 %} ðŸ’¤ Waiting for better prices
              {% else %}
                 
                 {# --- 3. CALCULATE REQUIRED SLOTS --- #}
                 {% set hrs_need = ((100-soc)/5)*(35/60) if soc >= 95 else (16.8*((95-soc)/100)/3.15 + 35/60) %}
                 {% set slots_needed = (hrs_need * 4) | round(0, 'ceil') | int %}
                 
                 {# --- 4. DEFINE TIME WINDOW --- #}
                 {% set t = now() %}
                 {% set r = states('input_datetime.ev_ready_by') | default('07:00:00') %}
                 {% set dl = t.replace(hour=r.split(':')[0]|int, minute=r.split(':')[1]|int, second=0) %}
                 {% if dl <= t %}{% set dl = dl + timedelta(days=1) %}{% endif %}
                 
                 {# --- 5. COLLECT & FILTER SLOTS --- #}
                 {% set raw = (raw_today or []) + (state_attr(nordpool_sensor, 'raw_tomorrow') or []) %}
                 {% set c = namespace(l=[]) %}
                 
                 {% for s in raw %}
                   {# Check: In future? Before deadline? Cheaper than limit? #}
                   {% if as_datetime(s.end) > t and as_datetime(s.start) < dl and (s.value * 100) <= lim + 0.01 %}
                     {% set c.l = c.l + [s] %}
                   {% endif %}
                 {% endfor %}
                 
                 {# --- 6. SORT & TRIM --- #}
                 {% set sel = (c.l | sort(attribute='start'))[:slots_needed] %}
                 
                 {# --- 7. MERGE CONSECUTIVE SLOTS --- #}
                 {% set ns = namespace(res="", s=none, e=none) %}
                 {% for s in sel %}
                   {% set ss = as_datetime(s.start) %}
                   {% set se = as_datetime(s.end) %}
                   
                   {% if ns.s is none %}
                     {% set ns.s = ss %}{% set ns.e = se %}
                   {% elif ss == ns.e %}
                     {% set ns.e = se %}
                   {% else %}
                     {% set ns.res = ns.res + ns.s.strftime('%H:%M') + "-" + ns.e.strftime('%H:%M') + ", " %}
                     {% set ns.s = ss %}{% set ns.e = se %}
                   {% endif %}
                 {% endfor %}
                 
                 {% if ns.s is not none %}
                   {% set ns.res = ns.res + ns.s.strftime('%H:%M') + "-" + ns.e.strftime('%H:%M') %}
                 {% endif %}
                 
                 {# --- 8. FINAL OUTPUT --- #}
                 {{ ns.res if ns.res != "" else "Waiting for cheap slots..." }}
              {% endif %}
            {% endif %}
          ui_status: >
             {% set soc = states('sensor.volvo_xc60_battery') | float(0) %}
             {% if soc >= 100 %}Idle
             {% else %}
               {% set mode = states('input_select.ev_charge_mode') %}
               {% if mode == 'Force Charge' %}Charging
               {% elif is_state('switch.breaker_switch','on') %}Charging
               {% elif 'Est' in (this.attributes.schedule_text | default('')) %}Predicting
               {% elif 'Gap' in (this.attributes.schedule_text | default('')) %}Gap Filling
               {% elif 'pending' in (this.attributes.schedule_text | default('pending')) %}Waiting
               {% else %}Paused{% endif %}
             {% endif %}

          ui_reason: >
            {% set volvo_state = states('sensor.volvo_xc60_battery') %}
            {% set nordpool_state = states('sensor.nordpool_enefit') %}
            
            {% if volvo_state in ['unavailable', 'unknown', 'none'] or nordpool_state in ['unavailable', 'unknown', 'none'] %}
               {% if now().hour < 7 %} ðŸ†˜ Failsafe: Charging (Night Mode)
               {% else %} ðŸ†˜ Failsafe: Waiting for Midnight (00:00)
               {% endif %}
            
            {% else %}
               {# ... Your existing normal status logic ... #}
               {% set soc = volvo_state | float(0) %}
               {% if soc >= 100 %} âœ… Battery is full
               {% else %}
                 {% set mode = states('input_select.ev_charge_mode') %}
                 {% set sched = this.attributes.schedule_text | default('pending') %}
                 {% if mode == 'Force Charge' %} âš ï¸ Force Charge Active
                 {% elif mode == 'Manual Limit' %} ðŸ”’ Manual Limit ({{ states('input_number.ev_limit_override_value') }}c) Active
                 {% elif is_state('switch.breaker_switch','on') %} âš¡ Charging (Price is good)
                 {% elif 'DATA OFFLINE' in sched %} ðŸ†˜ API Failure: Safety Charge
                 {% elif 'Gap' in sched %} ðŸ“‰ Filling gap with cheapest slots
                 {% elif 'Est' in sched %} ðŸ”® Prediction: Tomorrow morning is cheap
                 {% elif sched == 'pending' %} â³ Waiting for tomorrow's prices (~14:00)
                 {% else %} ðŸ’¤ Waiting for cheaper slots {% endif %}
               {% endif %}
            {% endif %}

      - name: "Breaker Total Power kW v4"
        unique_id: breaker_total_power_kw_v4_unified
        unit_of_measurement: "kW"
        device_class: power
        state: >
          {% set a = states('sensor.breaker_phase_a_power')|float(0) %}
          {% set b = states('sensor.breaker_phase_b_power')|float(0) %}
          {% set c = states('sensor.breaker_phase_c_power')|float(0) %}
          {% set total_raw = a + b + c %}
          
          {# AUTO-DETECT: If total is > 100, it's Watts. If < 100, it's likely already kW #}
          {% if total_raw > 100 %}
            {{ (total_raw / 1000) | round(3) }}
          {% else %}
            {{ total_raw | round(3) }}
          {% endif %}

      - name: "Breaker Cost Rate v4"
        unique_id: breaker_cost_rate_v4_unified
        unit_of_measurement: "EUR/h"
        state: >
          {% set p = states('sensor.breaker_total_power_kw_v4')|float(0) %}
          {% set price_eur = state_attr('sensor.nordpool_enefit', 'current_price') | float(0) %}
          {{ (p * price_eur) | round(3) }}


# [FIX 4: Average Price Calculation]
      - name: "Breaker Average Price v4"
        unique_id: breaker_average_price_v4_unified
        unit_of_measurement: "c/kWh"
        state: >
          {% set c = states('sensor.breaker_total_cost_v4') | float(0) %}
          {% set e = states('sensor.breaker_total_energy_v4') | float(0) %}
          {{ ((c / e) * 100) | round(2) if e > 0 else 0 }}

# --- 3. INTEGRATION SENSORS ---
sensor:
  - platform: integration
    unique_id: breaker_total_energy_v4_integrated
    source: sensor.breaker_total_power_kw_v4
    name: "Breaker Total Energy v4"
    method: left
    unit_time: h
    round: 3  
  - platform: integration
    unique_id: breaker_total_cost_v4_integrated
    source: sensor.breaker_cost_rate_v4
    name: "Breaker Total Cost v4"
    method: left
    unit_time: h
    round: 3 

# --- 4. UTILITY METERS  ---

utility_meter:
  breaker_daily_energy_v4:
    source: sensor.breaker_total_energy_v4
    cycle: daily
    unique_id: ut_daily_energy_v4
  breaker_daily_cost_v4:
    source: sensor.breaker_total_cost_v4
    cycle: daily
    unique_id: ut_daily_cost_v4
  breaker_monthly_energy_v4:
    source: sensor.breaker_total_energy_v4
    cycle: monthly
    unique_id: ut_monthly_energy_v4
  breaker_monthly_cost_v4:
    source: sensor.breaker_total_cost_v4
    cycle: monthly
    unique_id: ut_monthly_cost_v4
# --- 5. AUTOMATIONS ---
automation:
  # 1. MAIN CHARGE CONTROLLER (Simplified)
  - alias: "EV â€“ Charge Controller (XC60 V7.3)"
    id: ev_charge_controller_xc60_v7_3
    mode: restart
    trigger:
      - platform: time_pattern
        minutes: "/1"
      - platform: state
        entity_id: 
          - sensor.volvo_xc60_battery
          - sensor.ev_smart_charging_limit
          - input_select.ev_charge_mode
          - sensor.nordpool_enefit
    action:
      - variables:
          soc: "{{ states('sensor.volvo_xc60_battery') | float(0) }}"
          limit: "{{ states('sensor.ev_smart_charging_limit') | float(0) }}"
          # FAILSAFE PRICE: If attribute is missing, assume 0.0 (Cheap) so we charge
          current_price: "{{ state_attr('sensor.nordpool_enefit', 'current_price') | float(0) * 100 }}"
      - choose:
          - conditions: ["{{ soc < 100 }}", "{{ current_price <= limit + 0.01 }}", "{{ limit > 0 }}"]
            sequence: [{ service: switch.turn_on, target: { entity_id: switch.breaker_switch } }]
          - conditions: []
            sequence: [{ service: switch.turn_off, target: { entity_id: switch.breaker_switch } }]


  # 2. SMART RESET (Same as before)
  - alias: "EV â€“ Smart Reset on Departure"
    id: ev_smart_reset_on_departure
    mode: restart
    trigger:
      - platform: state
        entity_id: sensor.volvo_xc60_charging_connection_status
        from: "Connected"
        for: { minutes: 5 }
    action:
      - service: input_datetime.set_datetime
        target: { entity_id: input_datetime.ev_ready_by }
        data: { time: "07:00:00" }
      - service: input_select.select_option
        target: { entity_id: input_select.ev_charge_mode }
        data: { option: "Auto (Smart)" }
